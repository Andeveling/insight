// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model User {
  id            String   @id @default(uuid())
  name          String
  email         String   @unique
  emailVerified Boolean  @default(false)
  image         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions      Session[]
  accounts      Account[]
  profile       UserProfile?
  teamMembers   TeamMember[]
  userStrengths UserStrength[]
  reports       Report[]

  @@index([email])
}

model Session {
  id        String   @id @default(uuid())
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Account {
  id                    String    @id @default(uuid())
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@index([userId])
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([identifier, value])
}

// Extended user profile information
model UserProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  career          String?
  age             Int?
  gender          String? // 'M', 'F', 'O'
  description     String?
  hobbies         String? // JSON array stored as string
  profileImageUrl String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// Teams
model Team {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members TeamMember[]
  reports Report[]

  @@index([name])
}

// Team membership (many-to-many relationship)
model TeamMember {
  id        String   @id @default(uuid())
  userId    String
  teamId    String
  role      String? // Optional role within the team
  joinedAt  DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([userId, teamId])
  @@index([userId])
  @@index([teamId])
}

// Strength domains (Doing, Feeling, Motivating, Thinking)
model Domain {
  id                 String   @id @default(uuid())
  name               String   @unique // "Doing", "Feeling", "Motivating", "Thinking"
  nameEs             String // Spanish name
  description        String
  metaphor           String
  keyQuestion        String
  summary            String
  contributionToTeam String // JSON array stored as string
  potentialPitfall   String
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  strengths     Strength[]
  domainFocuses DomainFocus[]

  @@index([name])
}

// Strengths catalog
model Strength {
  id                      String   @id @default(uuid())
  name                    String   @unique // English name (e.g., "Deliverer")
  nameEs                  String // Spanish name (e.g., "Cumplidor")
  domainId                String
  briefDefinition         String
  fullDefinition          String
  howToUseMoreEffectively String? // JSON array stored as string
  watchOuts               String? // JSON array stored as string
  strengthsDynamics       String?
  bestPartners            String? // JSON array stored as string
  careerApplications      String? // JSON array stored as string
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  domain        Domain         @relation(fields: [domainId], references: [id], onDelete: Cascade)
  userStrengths UserStrength[]

  @@index([domainId])
  @@index([name])
}

// User's selected strengths (many-to-many, limited to 5 per user)
model UserStrength {
  id         String   @id @default(uuid())
  userId     String
  strengthId String
  rank       Int // 1-5, representing the order of importance
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  strength Strength @relation(fields: [strengthId], references: [id], onDelete: Cascade)

  @@unique([userId, strengthId])
  @@unique([userId, rank])
  @@index([userId])
  @@index([strengthId])
}

// Focus axes for culture calculation
// Represents the two axes: Energy (Action/Reflection) and Orientation (Results/People)
model Focus {
  id          String   @id @default(uuid())
  name        String   @unique // "Action", "Reflection", "Results", "People"
  nameEs      String // Spanish name
  axis        String // "energy" or "orientation"
  description String
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations to domains that contribute to this focus
  domainFocuses           DomainFocus[]
  // Relations to cultures
  cultureFocusEnergy      Culture[]     @relation("CultureEnergy")
  cultureFocusOrientation Culture[]     @relation("CultureOrientation")

  @@index([name])
  @@index([axis])
}

// Many-to-many relationship between Domain and Focus
// Each domain contributes to exactly 2 focuses (one per axis)
model DomainFocus {
  id        String   @id @default(uuid())
  domainId  String
  focusId   String
  weight    Float    @default(1.0) // Weight of contribution (for future fine-tuning)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  domain Domain @relation(fields: [domainId], references: [id], onDelete: Cascade)
  focus  Focus  @relation(fields: [focusId], references: [id], onDelete: Cascade)

  @@unique([domainId, focusId])
  @@index([domainId])
  @@index([focusId])
}

// Team Cultures that emerge from domain combinations
model Culture {
  id                 String   @id @default(uuid())
  name               String   @unique // "Execution", "Influence", "Strategy", "Cohesion"
  nameEs             String // Spanish name
  subtitle           String // Short metaphor
  description        String // Full description
  focusEnergyId      String // Action or Reflection
  focusOrientationId String // Results or People
  attributes         String // JSON array of key attributes
  icon               String?
  color              String // For UI theming
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  focusEnergy      Focus @relation("CultureEnergy", fields: [focusEnergyId], references: [id])
  focusOrientation Focus @relation("CultureOrientation", fields: [focusOrientationId], references: [id])

  @@unique([focusEnergyId, focusOrientationId])
  @@index([name])
}

// ============================================================
// AI-Generated Reports
// ============================================================

enum ReportType {
  // Individual Reports
  INDIVIDUAL_FULL // Full personal report with all sections
  INDIVIDUAL_STRENGTHS // Core strengths report
  INDIVIDUAL_DEVELOPMENT // Development opportunities
  INDIVIDUAL_RELATIONSHIPS // Strengths and relationships

  // Team Reports
  TEAM_CULTURE // Team culture map analysis
  TEAM_STRENGTHS_DISTRIBUTION // Strengths distribution across team
  TEAM_DOMAIN_COVERAGE // Domain coverage analysis
  TEAM_FULL // Full team assessment
}

enum ReportStatus {
  PENDING // Report requested but not started
  GENERATING // AI is generating the report
  COMPLETED // Report generated successfully
  FAILED // Report generation failed
}

model Report {
  id        String       @id @default(uuid())
  type      ReportType
  status    ReportStatus @default(PENDING)
  version   Int          @default(1) // Track changes over time
  content   String? // JSON serialized report content
  error     String? // Error message if failed
  modelUsed String? // AI model used for generation
  metadata  String? // JSON with generation metadata (tokens, duration, etc.)
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  // Relations - one of these will be set based on report type
  userId String?
  teamId String?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)
  team Team? @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([type, userId]) // Prevent duplicate individual reports per type
  @@unique([type, teamId]) // Prevent duplicate team reports per type
  @@index([userId])
  @@index([teamId])
  @@index([type])
  @@index([status])
}
